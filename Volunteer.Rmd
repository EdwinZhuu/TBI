---
title: "glm"
output: html_document
---

```{r, include=FALSE}

library(readxl)
library(fuzzyjoin)
library(dplyr)
library(tidyr)
library(xlsx)

# Open WMF table
WMF = read_excel("C:/Users/Edwin/Desktop/Volunteer/CANTBI DTI JHU stats.xlsx", sheet = "WMF", skip = 1, col_names = TRUE)
labels = read_excel("C:/Users/edwin/Desktop/Volunteer/CANTBIANationalBioba_DATA_LABELS_2020-01-13_0952.xlsx")

colnames(labels)[1] = "subject"
colnames(labels)[5] = "age"
labels = labels %>% drop_na(subject)

labelsWMF = regex_inner_join(WMF, labels, by = "subject")
colnames(labelsWMF)[1] = "subject"
labelsWMF$group = ifelse(grepl("TC{1}", labelsWMF$subject), "0", "1")
labelsWMF$`Centered Age` = labelsWMF$age - mean(unlist(labelsWMF$age))
WMF_Skeleton_ROI_Centered = labelsWMF[1:148,c(1:50,74:91)]
WMF_Skeleton_ROI[,2:50] = lapply(WMF_Skeleton_ROI[,2:50], function(x) as.double(as.character(x)))
WMF_Skeleton_Tract_Centered = labelsWMF[1:148,c(52:72,74:91)]
WMF_Skeleton_Tract[,1:21] = lapply(WMF_Skeleton_Tract[,1:21], function(x) as.double(as.character(x)))

WMF_Skeleton_ROI_Centered = WMF_Skeleton_ROI[,c(1:50,54,67,68)]
WMF_Skeleton_Tract_Centered = WMF_Skeleton_Tract[,c(1:21,25,38,39)]


WMF_ROI_matrix = matrix(nrow = 7, ncol = 49)
rownames(WMF_ROI_matrix) = c("P-value int", "Adjusted P-value int", "P-value age", "Adjusted P-value age",
                             "P-value group", "Adjust P-value group", "Effect size")
colnames(WMF_ROI_matrix) = colnames(WMF_Skeleton_ROI[2:50])

for (j in 2:50){
  ROI_output = glm(unlist(WMF_Skeleton_ROI_Centered[,j]) ~ `Centered Age` + group, data = WMF_Skeleton_ROI_Centered)
  mean_test = WMF_Skeleton_ROI_Centered[which(WMF_Skeleton_ROI_Centered$group == 1), j]
  mean_test = unlist(mean_test[!is.na(mean_test),1])
  mean_control = WMF_Skeleton_ROI_Centered[which(WMF_Skeleton_ROI_Centered$group == 0), j]
  mean_control = unlist(mean_control[!is.na(mean_control),1])
  WMF_ROI_matrix[1,j-1] = summary(ROI_output)$coefficient[1,4]
  WMF_ROI_matrix[3,j-1] = summary(ROI_output)$coefficient[2,4]
  WMF_ROI_matrix[5,j-1] = summary(ROI_output)$coefficient[3,4]
  WMF_ROI_matrix[7,j-1] = (mean(mean_test) - mean(mean_control))/
                          (sqrt((length(mean_test) - 1) * sd(mean_test)^2 + (length(mean_control) - 1) * sd(mean_control)^2)/
                                  (length(mean_test) + length(mean_control) -2))
  if (j == 50){
    WMF_ROI_matrix[2,] = p.adjust(WMF_ROI_matrix[1,], method = "fdr")
    WMF_ROI_matrix[4,] = p.adjust(WMF_ROI_matrix[3,], method = "fdr")
    WMF_ROI_matrix[6,] = p.adjust(WMF_ROI_matrix[5,], method = "fdr")
  }
}

WMF_Tract_matrix 
#write.xlsx(WMF_ROI_matrix, "Output.xlsx")


```
